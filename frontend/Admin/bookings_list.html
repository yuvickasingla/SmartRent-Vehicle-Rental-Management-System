<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>All Bookings | Admin | SmartRent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/style.css">
  <script src="../static/config.js"></script>
</head>

<body>

<header class="site-header">
  <div class="container nav">

    <a href="../index.html" class="nav__brand">
      <div class="nav__logo"></div>
      <div class="nav__brand-text">
        <span>SmartRent</span>
        <span>Admin Panel</span>
      </div>
    </a>

    <input type="checkbox" id="nav-toggle" class="nav__toggle">
    <label for="nav-toggle" class="nav__burger">☰</label>

    <ul class="nav__links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="vehicles_list.html">Vehicles</a></li>
      <li><a href="vehicle_add.html">Add Vehicle</a></li>
      <li><a href="drivers_list.html">Drivers</a></li>
      <li><a href="driver_add.html">Add Driver</a></li>
      <li><a href="customers_list.html">Customers</a></li>
      <li><a href="bookings_list.html">Bookings</a></li>
      <li><a href="payments_list.html">Payments</a></li>
      <li><a href="maintenance_list.html">Maintenance</a></li>
      <li><a href="maintenance_add.html">Add Maintenance</a></li>

      <li class="nav__cta"><a href="#" onclick="logoutAdmin()">Logout</a></li>
    </ul>

  </div>
</header>


<main>
<section class="page-shell">
  <div class="container">

    <div class="section-header">
      <h1>All Bookings</h1>
      <p>View every booking made by customers in your fleet system.</p>
    </div>

    <div class="table-shell">
      <table>
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Customer</th>
            <th>Vehicle</th>
            <th>Date</th>
            <th>Days</th>
            <th>Driver</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody id="bookingsTable">
          <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
        </tbody>

      </table>
    </div>

  </div>
</section>
</main>

<footer>
  <div class="container">
    <span>© 2025 SmartRent</span>
  </div>
</footer>

<script>
    let customers = [];
    let vehicles = [];
    
    // -------------------------------
    //  Check Admin Session
    // -------------------------------
    async function checkAdmin() {
      try {
        const res = await fetch(window.API_BASE_URL + "/auth/login", {
          method: "GET",
          credentials: "include"
        });
    
        if (!res.ok) {
          window.location.href = "../login.html";
          return;
        }
    
        const data = await res.json();
    
        if (data.role !== "admin") {
          window.location.href = "../login.html";
          return;
        }
    
      } catch {
        window.location.href = "../login.html";
      }
    }
    
    // -------------------------------
    //  Load customers + vehicles + bookings
    // -------------------------------
    async function loadData() {
      const body = document.getElementById("bookingsTable");
      body.innerHTML = `<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>`;
    
      try {
        // Customers
        const custRes = await fetch(window.API_BASE_URL + "/auth/customers", {
          credentials: "include"
        });
        customers = await custRes.json();
    
        // Vehicles
        const vehRes = await fetch(window.API_BASE_URL + "/vehicles/", {
          credentials: "include"
        });
        vehicles = await vehRes.json();
    
        // Bookings
        const bookRes = await fetch(window.API_BASE_URL + "/bookings/all", {
          credentials: "include"
        });
        const bookings = await bookRes.json();
    
        renderTable(bookings);
    
      } catch (err) {
        body.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Failed to load data</td></tr>`;
      }
    }
    
    function getCustomerName(id) {
      const c = customers.find(x => x.id === id);
      return c ? c.name : "Unknown";
    }
    
    function getVehicleName(id) {
      const v = vehicles.find(x => x.id === id);
      return v ? `${v.brand} ${v.model}` : "Unknown";
    }
    
    // Badge for status
    function badge(status) {
      if (status === "completed")
        return `<span class="badge badge-success">Completed</span>`;
      if (status === "confirmed" || status === "pending")
        return `<span class="badge badge-warning">Active</span>`;
      if (status === "cancelled")
        return `<span class="badge badge-danger">Cancelled</span>`;
      return `<span class="badge badge-dark">${status}</span>`;
    }
    
    // -------------------------------
    //  Render Table
    // -------------------------------
    function renderTable(list) {
      const body = document.getElementById("bookingsTable");
      body.innerHTML = "";
    
      list.forEach(b => {
        const start = b.start_date ? b.start_date.split("T")[0] : "-";
        const end = b.end_date ? b.end_date.split("T")[0] : "-";
    
        // Calculate days
        const days = (start && end)
          ? Math.max(1, Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)))
          : "-";
    
        body.innerHTML += `
          <tr>
            <td>${b.id}</td>
            <td>${getCustomerName(b.customer_id)}</td>
            <td>${getVehicleName(b.vehicle_id)}</td>
            <td>${start} → ${end}</td>
            <td>${days}</td>
            <td>${b.driver_id ? "Yes" : "No"}</td>
            <td>${badge(b.status)}</td>
          </tr>
        `;
      });
    }
    
    // -------------------------------
    //  Logout
    // -------------------------------
    async function logoutAdmin() {
      await fetch(window.API_BASE_URL + "/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      window.location.href = "../login.html";
    }
    
    // Initialize
    checkAdmin().then(loadData);
    </script>
    

</body>
</html>
